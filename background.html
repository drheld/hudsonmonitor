<!--
/*
 * Hudson Monitor Chrome Extension
 * Copyright 2010 by Henning Hoefer
 */
-->
<html>
	<head>
		<script type="text/javascript" src="constants.js"></script>
		<script type="text/javascript">
			var errorCount;
			var refreshTime;
			var requestUrl;
			var auth;
			var jobs;
			var desc;
			
			function init() {
				desc = localStorage.desc == 'true';
				errorCount = 0;
				if (!localStorage.url) {
					updateStatus(-1);
					jobs = null;
					return;
				} else
					requestUrl = localStorage.url;
				
				refreshTime = localStorage.refreshTime || REFRESH_DEFAULT;
				refreshTime *= 60 * 1000; // minutes in ms
				
				if (typeof localStorage.username == 'string') {
					auth = base64((localStorage.username || '') + ':' + (localStorage.password || ''))
				} else {
					auth = null;
				}
				
				doRequest();
			}
			
			function doRequest() {
				var xhr = new XMLHttpRequest();
				var abortTimer = window.setTimeout(function() {
					xhr.abort();
				}, REQUEST_TIMEOUT);
				
				function handleSuccess(status) {
					window.clearTimeout(abortTimer);
					errorCount = 0;
					updateStatus(status);
					window.setTimeout(doRequest, refreshTime);
				}
				
				function handleError(error) {
					window.clearTimeout(abortTimer);
					errorCount++;
					jobs = null;
					updateStatus('ERROR');
					if (errorCount <= 10)
						console.error(error);
					window.setTimeout(doRequest, refreshTime);
				}
				
				try {
					xhr.onreadystatechange = function() {
						if (xhr.readyState != 4)
							return;
						
						if (xhr.status == 200 && xhr.responseText) {
							var response = JSON.parse(xhr.responseText);
							var topStatus = -1;
							if (response.jobs) {
								jobs = response.jobs;
								if (localStorage.sorting == 'status') {
									jobs.sort(sortByStatus);
								} else {
									jobs.sort(sortByName);
								}
								for (var i in response.jobs)
									topStatus = Math.max(topStatus, STATUSES[response.jobs[i].color]);
							}
							handleSuccess(topStatus);
							return;
						}
						
						handleError(xhr.status != 200 ? 'HTTP ' + xhr.status : 'No responseText found');
					}
					
					xhr.onerror = function(error) {
						handleError(error);
					}
					
					xhr.open('GET', requestUrl + 'api/json', true);
					if (typeof auth == 'string')
						xhr.setRequestHeader('Authorization', 'Basic ' + auth);
					xhr.send();
				} catch (e) {
					console.error('Exception occurred: ' + e);
					handleError(e);
				}
			}
			
			function sortByName(a, b) {
				var o1 = a.name.toLowerCase();
				var o2 = b.name.toLowerCase();
				
				if (o1 < o2) return desc ? 1 : -1;
				else if (o2 < o1) return desc ? -1 : 1;
				else return 0;
			}
			
			function sortByStatus(a, b) {
				return desc ? STATUSES[a.color] - STATUSES[b.color] : STATUSES[b.color] - STATUSES[a.color];
			}
			
			function updateStatus(status) {
				if (status == 0) {
					chrome.browserAction.setIcon({path:'images/grey19.png'});
					chrome.browserAction.setBadgeText({text:''});
				} else if (status == 1) {
					chrome.browserAction.setIcon({path:'images/blue19.png'});
					chrome.browserAction.setBadgeText({text:''});
				} else if (status == 2) {
					chrome.browserAction.setIcon({path:'images/yellow19.png'});
					chrome.browserAction.setBadgeText({text:''});
				} else if (status == 3) {
					chrome.browserAction.setIcon({path:'images/red19.png'});
					chrome.browserAction.setBadgeText({text:''});
				} else {
					chrome.browserAction.setIcon({path:'images/icon19.png'});
					chrome.browserAction.setBadgeText({text:'?'});
				}
			}
			
			// This code was written by Tyler Akins and has been placed in the
			// public domain.  It would be nice if you left this header intact.
			// Base64 code from Tyler Akins -- http://rumkin.com
			function base64(input) {
				var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
				var output = "";
				var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
				var i = 0;
				while (i < input.length) {
					chr1 = input.charCodeAt(i++);
					chr2 = input.charCodeAt(i++);
					chr3 = input.charCodeAt(i++);
					enc1 = chr1 >> 2;
					enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
					enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
					enc4 = chr3 & 63;
					if (isNaN(chr2))
						enc3 = enc4 = 64;
					else if (isNaN(chr3))
						enc4 = 64;
					output += (keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4));
				}
				return output;
			}
			
			window.onload = function() {
				window.setTimeout(init, 10);
			}
		</script>
	</head>
</html>